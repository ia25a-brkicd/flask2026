<!doctype html>
<html>
  <head>
    <title>{% block title %}{% endblock %}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/base.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/warenkorb.css') }}"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    {% block head %}{% endblock %}
  </head>
  <body data-page="{{ request.endpoint }}">
    <header class="main-header">
      <div class="header-container">
        <button
          class="mobile-menu-toggle"
          aria-label="Menu"
          onclick="toggleMobileMenu()"
        >
          <i class="fa fa-bars"></i>
        </button>

        <nav class="nav-left">
          <div class="nav-item-with-dropdown">
            <a
              href="{{ url_for('shop') }}"
              class="nav-link nav-link-with-icon {% if request.endpoint == 'shop' %}active{% endif %}"
            >
              <i class="fa fa-store"></i>
              Shop
            </a>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item">
                <i class="fa fa-soap"></i>
                Classic Soaps
              </a>
              <a href="#" class="dropdown-item">
                <i class="fa fa-gem"></i>
                Luxury Soaps
              </a>
              <a href="#" class="dropdown-item">
                <i class="fa fa-heart"></i>
                Gift Sets
              </a>
              <a href="#" class="dropdown-item">
                <i class="fa fa-droplet"></i>
                Soap Bundles
              </a>
            </div>
          </div>
          <a
            href="{{ url_for('about_us') }}"
            class="nav-link nav-link-with-icon {% if request.endpoint == 'about_us' %}active{% endif %}"
          >
            <i class="fa fa-info-circle"></i>
            About us
          </a>
          <a
            href="{{ url_for('contact') }}"
            class="nav-link nav-link-with-icon {% if request.endpoint == 'contact' %}active{% endif %}"
          >
            <i class="fa fa-envelope"></i>
            Contact
          </a>
        </nav>

        <a href="{{ url_for('home') }}" class="logo" aria-label="Floravis">
          <img src="../static/floravis.png" alt="Floravis" class="logo-img" />
          <span class="visually-hidden">Floravis</span>
        </a>

        <div class="nav-right">
          <button
            class="search-toggle"
            aria-label="Search"
            onclick="toggleSearch()"
          >
            <i class="fa fa-search"></i>
          </button>
          <a
            href="{{ url_for('warenkorb') }}"
            class="nav-link nav-link-with-icon cart-link {% if request.endpoint == 'warenkorb' %}active{% endif %}"
          >
            <i class="fa fa-shopping-cart"></i>
            <span class="cart-text-container">
              Shopping Cart
              <span class="cart-badge" id="cartBadge">0</span>
            </span>
          </a>
          <div class="nav-item-with-dropdown">
            <a
          {% if session.get('user_id') %}
    <!-- Eingeloggt: Profil-Link -->
            <a
              href="{{ url_for('profil') }}"
              class="nav-link nav-link-with-icon {% if request.endpoint == 'profil' %}active{% endif %}"
            >
              <i class="fa fa-user"></i>
              Profile
            </a>
          {% else %}
          <!-- Nicht eingeloggt: Login-Link -->
            <a
              href="{{ url_for('profil') }}"
              class="nav-link nav-link-with-icon {% if request.endpoint == 'profil' %}active{% endif %}"
            >
              <i class="fa fa-sign-in-alt"></i>
              Login
            </a>
          {% endif %}

            <div class="dropdown-menu dropdown-menu-right">
              <a href="{{ url_for('profil') }}" class="dropdown-item">
                <i class="fa fa-user-circle"></i>
                My Profile
              </a>
              <a href="{{ url_for('orders') }}" class="dropdown-item">
                <i class="fa fa-box"></i>
                Orders
              </a>
              <a href="{{ url_for('settings') }}" class="dropdown-item">
                <i class="fa fa-cog"></i>
                Settings
              </a>
              <div class="dropdown-divider"></div>
              <a href="{{ url_for('logout') }}" class="dropdown-item">
                <i class="fa fa-sign-out-alt"></i>
                Logout
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="search-bar-container">
        <form
          class="search-form"
          action="{{ url_for('home') }}"
          method="get"
          role="search"
          onsubmit="showSearchLoading(event)"
        >
          <div class="search-spinner" style="display: none">
            <i class="fa fa-spinner fa-spin"></i>
          </div>
          <input
            type="search"
            name="q"
            placeholder="Auf floravis.com suchen"
            aria-label="Search"
          />
          <button type="submit" aria-label="Search">
            <i class="fa fa-search"></i>
          </button>
        </form>
      </div>
    </header>
    <div class="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
    <main class="main-content">{% block content %}{% endblock %}</main>
    <script>
      function toggleSearch() {
        const header = document.querySelector(".main-header");
        const searchBar = document.querySelector(".search-bar-container");
        const input = searchBar.querySelector('input[type="search"]');

        header.classList.toggle("search-active");

        if (header.classList.contains("search-active")) {
          setTimeout(() => input.focus(), 300);
        }
      }

      // Close search when clicking outside
      document.addEventListener("click", function (event) {
        const header = document.querySelector(".main-header");
        const searchToggle = document.querySelector(".search-toggle");
        const searchBar = document.querySelector(".search-bar-container");

        if (
          header.classList.contains("search-active") &&
          !searchToggle.contains(event.target) &&
          !searchBar.contains(event.target)
        ) {
          header.classList.remove("search-active");
        }
      });

      // Compact header on scroll (with hysteresis to avoid jitter)
      const HEADER_SHRINK_AT = 80;
      const HEADER_EXPAND_AT = 40;
      let isScrolled = false;
      let scrollTicking = false;

      function updateHeaderOnScroll() {
        const header = document.querySelector(".main-header");
        const currentScroll = window.pageYOffset;

        if (!isScrolled && currentScroll > HEADER_SHRINK_AT) {
          header.classList.add("scrolled");
          isScrolled = true;
        } else if (isScrolled && currentScroll < HEADER_EXPAND_AT) {
          header.classList.remove("scrolled");
          isScrolled = false;
        }

        scrollTicking = false;
      }

      window.addEventListener("scroll", function () {
        if (!scrollTicking) {
          window.requestAnimationFrame(updateHeaderOnScroll);
          scrollTicking = true;
        }
      });

      // ESC key closes search
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          const header = document.querySelector(".main-header");
          if (header.classList.contains("search-active")) {
            header.classList.remove("search-active");
          }
          if (header.classList.contains("mobile-menu-active")) {
            toggleMobileMenu();
          }
        }
      });

      // Mobile menu toggle
      function toggleMobileMenu() {
        const header = document.querySelector(".main-header");
        const overlay = document.querySelector(".mobile-menu-overlay");
        header.classList.toggle("mobile-menu-active");
        overlay.classList.toggle("active");
        document.body.classList.toggle("menu-open");
      }

      // Search loading indicator
      function showSearchLoading(event) {
        const spinner = document.querySelector(".search-spinner");
        const searchBtn = document.querySelector(".search-form button");
        const input = document.querySelector(".search-form input");

        if (input.value.trim()) {
          spinner.style.display = "flex";
          searchBtn.style.opacity = "0.5";
        }
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function (event) {
        const dropdowns = document.querySelectorAll(".nav-item-with-dropdown");
        dropdowns.forEach((dropdown) => {
          if (!dropdown.contains(event.target)) {
            dropdown.classList.remove("active");
          }
        });
      });

      // Cart Counter System
      function initializeCartCounter() {
        const cartBadge = document.getElementById("cartBadge");
        if (cartBadge) {
          updateCartBadge();
        }
      }

      function updateCartBadge() {
        const cartBadge = document.getElementById("cartBadge");
        if (cartBadge) {
          const count = getCartCount();
          cartBadge.textContent = count;
          if (count > 0) {
            cartBadge.style.display = "flex";
          } else {
            cartBadge.style.display = "none";
          }
        }
      }

      function getCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");
        return cart.reduce((total, item) => total + item.quantity, 0);
      }

      function getCart() {
        return JSON.parse(localStorage.getItem("cart") || "[]");
      }

      function saveCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartBadge();
      }

      function addToCart(productName, quantity, price) {
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const existingItem = cart.find((item) => item.name === productName);

        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({ name: productName, quantity: quantity, price: price });
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartBadge();

        // Show success message
        showCartNotification(productName, quantity);
      }

      function removeFromCart(productName) {
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        cart = cart.filter((item) => item.name !== productName);
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartBadge();
      }

      function updateCartItemQuantity(productName, quantity) {
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        const item = cart.find((item) => item.name === productName);
        if (item) {
          item.quantity = quantity;
          if (item.quantity <= 0) {
            cart = cart.filter((i) => i.name !== productName);
          }
        }
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartBadge();
      }

      function clearCart() {
        localStorage.removeItem("cart");
        updateCartBadge();
      }

      function showCartNotification(productName, quantity) {
        // Remove old notification if exists
        const oldNotif = document.querySelector(".cart-notification");
        if (oldNotif) oldNotif.remove();

        const notification = document.createElement("div");
        notification.className = "cart-notification";
        notification.textContent = `✓ ${quantity}x ${productName} zum Warenkorb hinzugefügt`;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
        }, 10);

        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }

      // Initialize cart counter on page load
      document.addEventListener("DOMContentLoaded", initializeCartCounter);
    </script>
  </body>
</html>
