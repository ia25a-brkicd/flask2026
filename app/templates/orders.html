{% extends 'base.html' %} {% block title %}Bestellungen | Flor'Avis{% endblock
%} {% block head %}
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400;1,600&display=swap"
  rel="stylesheet"
/>

<link
  rel="stylesheet"
  href="{{ url_for('static', filename='styles/orders.css') }}"
/>
{% endblock %} {% block content %}
<div class="orders">
  <h1 id="title">Meine Bestellungen</h1>

  <!-- Orders Container -->
  <div class="orders-container" id="orders-container">
    {% if orders and orders|length > 0 %}
      {% for order in orders %}
      <div class="order-card">
        <div class="order-header">
          <div class="order-title-section">
            <h2>Bestellung #{{ order.get('order_id', '?') }}</h2>
            <span class="order-date">{{ order.get('date', 'Unbekannt')[:10] if order.get('date') else 'Unbekannt' }}</span>
          </div>
          <span class="order-status {{ order.get('status', 'unbekannt')|lower }}">{{ order.get('status', 'Unbekannt') }}</span>
        </div>
        <div class="order-items">
          {% set ns = namespace(qty=0, subtotal=0) %}
          {% for item in order.get('items', []) %}
          {% set ns.qty = ns.qty + item.get('quantity', 1) %}
          {% set item_total = ((item.get('quantity', 1) * item.get('price', 0))|int) + 0.99 %}
          {% set ns.subtotal = ns.subtotal + item_total %}
          <div class="order-item">
            <span class="item-name">{{ item.get('name', 'Produkt') }}</span>
            <span class="item-details">{{ item.get('quantity', 1) }} Ã— CHF {{ "%.2f"|format(item.get('price', 0)) }}</span>
            <span class="item-subtotal">CHF {{ "%.2f"|format(item_total) }}</span>
          </div>
          {% endfor %}
        </div>
        {% if ns.qty == 2 %}
          {% set discount_percent = 10 %}
        {% elif ns.qty >= 3 %}
          {% set discount_percent = 20 %}
        {% else %}
          {% set discount_percent = 0 %}
        {% endif %}
        {% set discounted_subtotal = ns.subtotal %}
        {% if discount_percent > 0 %}
          {% set discounted_subtotal = (ns.subtotal * (1 - discount_percent / 100))|int + 0.99 %}
        {% endif %}
        {% set final_total = (discounted_subtotal + 5.00)|int + 0.99 %}
        <div class="order-footer">
          {% if discount_percent > 0 %}
          <div class="discount-badge-circle order-discount-badge">
            <span>-{{ discount_percent }}%</span>
          </div>
          {% endif %}
          <span class="order-total-label">Gesamtpreis:</span>
          <span class="order-discount">Rabatt: {{ discount_percent }}%</span>
          <span class="order-shipping">Versand: CHF 5.00</span>
          <span class="order-total-price">CHF {{ "%.2f"|format(final_total) }}</span>
        </div>
      </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- Empty State (wird angezeigt wenn keine Bestellungen vorhanden) -->
  <div class="empty-orders" id="empty-orders" {% if orders and orders|length > 0 %}style="display: none"{% endif %}>
    <div class="empty-orders-message">
      <span class="empty-orders-icon">ðŸ“¦</span>
      <h2>Noch keine Bestellungen</h2>
      {% if not session.get('login_id') %}
      <p>Bitte melden Sie sich an, um Ihre Bestellungen zu sehen.</p>
      <a href="{{ url_for('login') }}" class="shop-button">
        Anmelden
        <span class="arrow">â†’</span>
      </a>
      {% else %}
      <p>
        Sie haben noch keine Bestellungen aufgegeben. Beginnen Sie jetzt mit Ihrem
        Einkauf!
      </p>
      <a href="{{ url_for('shop') }}" class="shop-button">
        Zum Shop gehen
        <span class="arrow">â†’</span>
      </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Zeige/Verstecke Container basierend auf Bestellungen
  document.addEventListener("DOMContentLoaded", function() {
    const container = document.getElementById("orders-container");
    const emptyState = document.getElementById("empty-orders");

    // PrÃ¼fe ob Bestellungen vorhanden sind (vom Server gerendert)
    const hasOrders = container.querySelectorAll('.order-card').length > 0;

    if (hasOrders) {
      container.style.display = "block";
      emptyState.style.display = "none";
    } else {
      container.style.display = "none";
      emptyState.style.display = "flex";
    }
  });
</script>

{% endblock %}
