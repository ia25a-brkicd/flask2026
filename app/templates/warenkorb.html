{% extends 'base.html' %} {% block title %}Warenkorb | Flor'Avis{% endblock %}
{% block content %}
<h1 class="title">Warenkorb</h1>
<hr class="section-line" />
<div
  class="shoppingcart-header"
  role="status"
  aria-live="polite"
  aria-atomic="true"
>
  <div class="title-shoppingcart">Warenkorb</div>
  <div class="title-shoppingcart-description">
    Du hast <span id="item-count" aria-label="Anzahl Artikel">0</span> Artikel
    in deinem Warenkorb
  </div>
</div>
<div
  class="shoppingcart"
  id="shoppingcart"
  role="list"
  aria-label="Warenkorbinhalte"
>
  <!-- Items werden dynamisch aus localStorage geladen -->
</div>

<hr class="section-line" />

<!-- Weitershoppen -->
<div class="keep-shopping" id="keep-shopping">
  <div class="keep-shopping-title">Weiter einkaufen</div>
  <div class="keep-shopping-links">
    <a href="{{ url_for('shop') }}" class="keep-shopping-btn">
      <i class="fa fa-th-large"></i>
      Alle Produkte
    </a>
    <a
      href="{{ url_for('shop', category='classic') }}"
      class="keep-shopping-btn"
    >
      <i class="fa fa-soap"></i>
      Klassisch
    </a>
    <a
      href="{{ url_for('shop', category='luxury') }}"
      class="keep-shopping-btn"
    >
      <i class="fa fa-gem"></i>
      Luxus
    </a>
  </div>
</div>

<div
  class="cart-summary"
  id="cart-summary"
  role="region"
  aria-label="Warenkorb Zusammenfassung"
>
  <div class="discount-badge-circle" id="discount-badge" style="display: none;">
    <span id="discount-text">0%</span>
  </div>
  <div class="cart-total" aria-live="assertive">
    <span class="cart-total-label">Gesamt:</span>
    <span class="cart-total-price"
      >CHF <span id="total-price" aria-label="Gesamtpreis">0.00</span></span
    >
  </div>
  <a
    href="{{ url_for('checkout') }}"
    class="continue-button"
    role="button"
    aria-label="Zur Bezahlung fortfahren"
  >
    Zur Bezahlung fortfahren
    <span class="arrow" aria-hidden="true">→</span>
  </a>
</div>

<!-- Leerer Warenkorb Nachricht (versteckt) -->
<div
  class="empty-cart"
  id="empty-cart"
  style="display: none"
  role="status"
  aria-live="polite"
>
  <div class="empty-cart-message">
    <span class="empty-cart-icon" aria-hidden="true"
      ><i class="fa fa-shopping-cart"></i
    ></span>
    <h2>Ihr Warenkorb ist leer</h2>
    <p>Fügen Sie Produkte hinzu, um fortzufahren.</p>
    <a
      href="{{ url_for('shop') }}"
      class="continue-button"
      role="button"
      aria-label="Zum Shop gehen"
    >
      Zum Shop gehen
      <span class="arrow" aria-hidden="true">→</span>
    </a>
  </div>
</div>

<script>
  // Calculate item line total without discount
  function calculateLineTotal(basePrice, quantity) {
    var total = basePrice * quantity;
    // Round to .99
    total = Math.floor(total) + 0.99;
    return total;
  }

  // Calculate discount based on total quantity
  function calculateDiscountPercent(totalQuantity) {
    if (totalQuantity === 2) {
      return 10;
    } else if (totalQuantity >= 3) {
      return 20;
    }
    return 0;
  }

  // Lade den Warenkorb aus localStorage und rendere die Items
  function loadCart() {
    var cart = getCart();
    var shoppingcartEl = document.getElementById("shoppingcart");
    shoppingcartEl.innerHTML = "";

    cart.forEach(function (item) {
      var itemEl = createCartItemElement(item);
      shoppingcartEl.appendChild(itemEl);
    });

    updateTotal();
  }

  // Erstelle ein HTML Element für ein Cart-Item
  function createCartItemElement(item) {
    var div = document.createElement("div");
    div.className = "item";
    div.setAttribute("data-price", item.price);
    div.setAttribute("data-name", item.name);
    div.setAttribute("role", "listitem");

    var itemTotal = calculateLineTotal(item.price, item.quantity);

    var cartImageByProductName = {
      "Vanille & Lemon Mix": "Green Apple & Lemon & Vanille Mix.jpg",
      "Rosen Garten Seife": "Green Apple & Lemon & Vanille Mix.jpg",
      "Honig Glühende Seife": "Green Apple & Lemon with Stamp.jpg"
    };

    var itemName = cartImageByProductName[item.name] || (item.name + ".jpg");

    div.innerHTML = `
                <img class="image" src="../../static/images/${itemName}" alt="${itemName} Produktbild" loading="lazy">
                <div class="shoppingcart-Itemname">${item.name}</div>
                <div class="count" aria-label="Menge">${item.quantity}</div>
                <div class="count-button" role="group" aria-label="Mengenänderung für ${item.name}">
                    <button type="button" class="count-button-button" onclick="increaseQuantity(this)" aria-label="Menge erhöhen" title="Menge erhöhen">
                        <img class="picture-up" src="../static/styles/images/count-dreieck.png" alt="">
                    </button>
                    <button type="button" class="count-button-down" onclick="decreaseQuantity(this)" aria-label="Menge senken" title="Menge senken">
                        <img class="picture-down" src="../static/styles/images/count-dreieck.png" alt="">
                    </button>
                </div>
                <div class="price" aria-label="Gesamtpreis für diesen artikel: CHF ${itemTotal.toFixed(2)}">CHF <span class="item-price">${itemTotal.toFixed(2)}</span></div>
                <div class="delete-buttons">
                    <button type="button" class="delete-button-button" onclick="deleteItem(this)" aria-label="Artikel aus Warenkorb entfernen" title="Artikel remove">
                        <img class="delete-img" src="../static/styles/images/Bild2.png" alt="">
                    </button>
                </div>
            `;

    return div;
  }

  // Berechne das Total und aktualisiere die Anzeige
  function updateTotal() {
    var items = document.querySelectorAll("#shoppingcart .item");
    var subtotal = 0;
    var itemCount = 0;

    for (var i = 0; i < items.length; i++) {
      var countEl = items[i].querySelector(".count");
      var quantity = parseInt(countEl.textContent);
      var price = parseFloat(items[i].getAttribute("data-price"));
      var itemTotal = calculateLineTotal(price, quantity);

      // Aktualisiere den Preis pro Zeile (ohne Rabatt)
      var priceEl = items[i].querySelector(".item-price");
      priceEl.textContent = itemTotal.toFixed(2);

      subtotal += itemTotal;
      itemCount += quantity;
    }

    // Apply discount based on total quantity
    var discountPercent = calculateDiscountPercent(itemCount);
    var total = subtotal;
    if (discountPercent > 0) {
      total = subtotal * (1 - discountPercent / 100);
      total = Math.floor(total) + 0.99;
    }

    // Update discount badge
    var discountBadge = document.getElementById("discount-badge");
    var discountText = document.getElementById("discount-text");
    if (discountPercent > 0) {
      discountText.textContent = "-" + discountPercent + "%";
      discountBadge.style.display = "flex";
    } else {
      discountBadge.style.display = "none";
    }

    // Aktualisiere Total
    document.getElementById("total-price").textContent = total.toFixed(2);

    // Aktualisiere Item-Count im Header
    document.getElementById("item-count").textContent = itemCount;

    // Zeige/Verstecke leeren Warenkorb
    var sectionLines = document.querySelectorAll(".section-line");

    if (items.length === 0) {
      document.getElementById("shoppingcart").style.display = "none";
      document.getElementById("cart-summary").style.display = "none";
      document.getElementById("empty-cart").style.display = "flex";
      document.querySelector(".shoppingcart-header").style.display = "none";
      sectionLines.forEach(function (line) {
        line.style.display = "none";
      });
    } else {
      document.getElementById("shoppingcart").style.display = "flex";
      document.getElementById("cart-summary").style.display = "flex";
      document.getElementById("empty-cart").style.display = "none";
      document.querySelector(".shoppingcart-header").style.display = "block";
      sectionLines.forEach(function (line) {
        line.style.display = "block";
      });
    }
  }

  // Erhöhe die Anzahl
  function increaseQuantity(button) {
    var item = button.closest(".item");
    var countEl = item.querySelector(".count");
    var productName = item.getAttribute("data-name");
    var currentCount = parseInt(countEl.textContent);
    countEl.textContent = currentCount + 1;

    // Update localStorage
    updateCartItemQuantity(productName, currentCount + 1);
    updateTotal();
  }

  // Verringere die Anzahl
  function decreaseQuantity(button) {
    var item = button.closest(".item");
    var countEl = item.querySelector(".count");
    var productName = item.getAttribute("data-name");
    var currentCount = parseInt(countEl.textContent);

    if (currentCount > 1) {
      countEl.textContent = currentCount - 1;
      // Update localStorage
      updateCartItemQuantity(productName, currentCount - 1);
      updateTotal();
    } else {
      // Wenn die Anzahl 1 ist, lösche das Item
      deleteItem(button);
    }
  }

  // Lösche ein Item
  function deleteItem(button) {
    var item = button.closest(".item");
    var productName = item.getAttribute("data-name");

    // Animation zum Ausblenden
    item.style.transition = "all 0.3s ease";
    item.style.opacity = "0";
    item.style.transform = "translateX(-50px)";

    setTimeout(function () {
      item.remove();
      // Aus localStorage entfernen
      removeFromCart(productName);
      updateTotal();
    }, 300);
  }

  // Initialisiere beim Laden
  document.addEventListener("DOMContentLoaded", function () {
    loadCart();
  });
</script>
{% endblock %}
