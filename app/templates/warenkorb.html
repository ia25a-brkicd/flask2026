{% extends 'base.html' %} {% block title %}Warenkorb | Flor'Avis{% endblock %}
{% block content %}
<h1 class="title">Warenkorb</h1>
<hr class="section-line" />
<div class="shoppingcart-header">
  <div class="title-shoppingcart">Warenkorb</div>
  <div class="title-shoppingcart-description">
    <<<<<<< HEAD Du hast <span id="item-count">0</span> Artikel in deinem
    Warenkorb ======= Sie haben <span id="item-count">0</span> Artikel in Ihrem
    Warenkorb >>>>>>> ae4852d6a7dbb87c317e4c27a95167277d96a8c1
  </div>
</div>
<div class="shoppingcart" id="shoppingcart">
  <!-- Items werden dynamisch aus localStorage geladen -->
</div>

<hr class="section-line" />

<div class="cart-summary" id="cart-summary">
  <div class="cart-total">
    <span class="cart-total-label">Gesamt:</span>
    <span class="cart-total-price">CHF <span id="total-price">0.00</span></span>
  </div>
  <a href="{{ url_for('checkout') }}" class="continue-button">
    Zur Bezahlung fortfahren
    <span class="arrow">→</span>
  </a>
</div>

<!-- Leerer Warenkorb Nachricht (versteckt) -->
<div class="empty-cart" id="empty-cart" style="display: none">
  <div class="empty-cart-message">
    <span class="empty-cart-icon"><i class="fa fa-shopping-cart"></i></span>
    <h2>Ihr Warenkorb ist leer</h2>
    <p>Fügen Sie Produkte hinzu, um fortzufahren.</p>
    <a href="{{ url_for('shop') }}" class="continue-button">
      Zum Shop gehen
      <span class="arrow">→</span>
    </a>
  </div>
</div>

<script>
  // Calculate discounted price based on quantity
  function calculateDiscountedPrice(basePrice, quantity) {
    var total = basePrice * quantity;

    if (quantity === 2) {
      total = total * 0.9; // 10% discount
    } else if (quantity >= 3) {
      total = total * 0.8; // 20% discount
    }

    // Round to .99
    total = Math.floor(total) + 0.99;
    return total;
  }

  // Lade den Warenkorb aus localStorage und rendere die Items
  function loadCart() {
    var cart = getCart();
    var shoppingcartEl = document.getElementById("shoppingcart");
    shoppingcartEl.innerHTML = "";

    cart.forEach(function (item) {
      var itemEl = createCartItemElement(item);
      shoppingcartEl.appendChild(itemEl);
    });

    updateTotal();
  }

  // Erstelle ein HTML Element für ein Cart-Item
  function createCartItemElement(item) {
    var div = document.createElement("div");
    div.className = "item";
    div.setAttribute("data-price", item.price);
    div.setAttribute("data-name", item.name);

    var itemTotal = calculateDiscountedPrice(item.price, item.quantity);

    var itemName = item.name + ".jpg";

    div.innerHTML = `
                <img class="image" src="../../static/images/${itemName}" alt="${itemName}">
                <div class="shoppingcart-Itemname">${item.name}</div>
                <div class="count">${item.quantity}</div>
                <div class="count-button">
                    <button type="button" class="count-button-button" onclick="increaseQuantity(this)">
                        <img class="picture-up" src="../static/styles/images/count-dreieck.png" alt="Plus">
                    </button>
                    <button type="button" class="count-button-down" onclick="decreaseQuantity(this)">
                        <img class="picture-down" src="../static/styles/images/count-dreieck.png" alt="Minus">
                    </button>
                </div>
                <div class="price">CHF <span class="item-price">${itemTotal.toFixed(2)}</span></div>
                <div class="delete-buttons">
                    <button type="button" class="delete-button-button" onclick="deleteItem(this)">
                        <img class="delete-img" src="../static/styles/images/Bild2.png" alt="Löschen">
                    </button>
                </div>
            `;

    return div;
  }

  // Berechne das Total und aktualisiere die Anzeige
  function updateTotal() {
    var items = document.querySelectorAll("#shoppingcart .item");
    var total = 0;
    var itemCount = 0;

    for (var i = 0; i < items.length; i++) {
      var countEl = items[i].querySelector(".count");
      var quantity = parseInt(countEl.textContent);
      var price = parseFloat(items[i].getAttribute("data-price"));
      var itemTotal = calculateDiscountedPrice(price, quantity);

      // Aktualisiere den Preis pro Zeile
      var priceEl = items[i].querySelector(".item-price");
      priceEl.textContent = itemTotal.toFixed(2);

      total += itemTotal;
      itemCount += quantity;
    }

    // Aktualisiere Total
    document.getElementById("total-price").textContent = total.toFixed(2);

    // Aktualisiere Item-Count im Header
    document.getElementById("item-count").textContent = itemCount;

    // Zeige/Verstecke leeren Warenkorb
    if (items.length === 0) {
      document.getElementById("shoppingcart").style.display = "none";
      document.getElementById("cart-summary").style.display = "none";
      document.getElementById("empty-cart").style.display = "flex";
      document.querySelector(".shoppingcart-header").style.display = "none";
    } else {
      document.getElementById("shoppingcart").style.display = "flex";
      document.getElementById("cart-summary").style.display = "flex";
      document.getElementById("empty-cart").style.display = "none";
      document.querySelector(".shoppingcart-header").style.display = "block";
    }
  }

  // Erhöhe die Anzahl
  function increaseQuantity(button) {
    var item = button.closest(".item");
    var countEl = item.querySelector(".count");
    var productName = item.getAttribute("data-name");
    var currentCount = parseInt(countEl.textContent);
    countEl.textContent = currentCount + 1;

    // Update localStorage
    updateCartItemQuantity(productName, currentCount + 1);
    updateTotal();
  }

  // Verringere die Anzahl
  function decreaseQuantity(button) {
    var item = button.closest(".item");
    var countEl = item.querySelector(".count");
    var productName = item.getAttribute("data-name");
    var currentCount = parseInt(countEl.textContent);

    if (currentCount > 1) {
      countEl.textContent = currentCount - 1;
      // Update localStorage
      updateCartItemQuantity(productName, currentCount - 1);
      updateTotal();
    } else {
      // Wenn die Anzahl 1 ist, lösche das Item
      deleteItem(button);
    }
  }

  // Lösche ein Item
  function deleteItem(button) {
    var item = button.closest(".item");
    var productName = item.getAttribute("data-name");

    // Animation zum Ausblenden
    item.style.transition = "all 0.3s ease";
    item.style.opacity = "0";
    item.style.transform = "translateX(-50px)";

    setTimeout(function () {
      item.remove();
      // Aus localStorage entfernen
      removeFromCart(productName);
      updateTotal();
    }, 300);
  }

  // Initialisiere beim Laden
  document.addEventListener("DOMContentLoaded", function () {
    loadCart();
  });
</script>
{% endblock %}
