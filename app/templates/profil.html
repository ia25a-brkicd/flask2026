{% extends 'base.html' %} {% block title %}Profil | Flor'Avis{% endblock %} {%
block head %}
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400;1,600&display=swap"
  rel="stylesheet"
/>
<link
  rel="icon"
  href="{{ url_for('static', filename='images/ProfilbildLogo.png') }}"
  type="image/x-icon"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='styles/contact.css') }}"
/>
{% endblock %} {% block content %}
<div class="contact-wrapper">
  <div class="contact-hero">
    <h1>Profil</h1>
    <p class="hero-subtitle">
      Willkommen {{ session.get('user_name', 'Gast') }} {{
      session.get('user_lastname', '') }}
    </p>
  </div>

  <div class="contact-container">
    {% if not session.get("user_id") %}
    <div class="form-section">
      <form action="{{ url_for('profil') }}" method="post">
        <div class="form-grid">
          <div class="input-group">
            <label for="lastname">
              <i class="fa fa-user"></i>
              Nachname
            </label>
            <input
              type="text"
              id="lastname"
              name="lastname"
              placeholder="Dein Nachname"
              required
            />
            <span class="input-border"></span>
          </div>

          <div class="input-group">
            <label for="firstname">
              <i class="fa fa-user"></i>
              Vorname
            </label>
            <input
              type="text"
              id="firstname"
              name="firstname"
              placeholder="Dein Vorname"
              required
            />
            <span class="input-border"></span>
          </div>
        </div>

        <div class="input-group">
          <label for="email">
            <i class="fa fa-envelope"></i>
            E-Mail-Adresse
          </label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="deine.email@beispiel.com"
            required
          />
          <span class="input-border"></span>
        </div>

        <div class="input-group">
          <label for="password">
            <i class="fa fa-lock"></i>
            Passwort
          </label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Passwort erstellen"
            required
          />
          <span class="input-border"></span>
        </div>

        <div class="input-group">
          <label for="password">
            <i class="fa fa-lock"></i>
            Passwort wiederholen
          </label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Passwort wiederholen"
            required
          />
          <span class="input-border"></span>
        </div>

        <button type="button" id="registrieren-btn" class="submit-btn">
          <span>Registrieren</span>
          <i class="fa fa-user-plus"></i>
        </button>

        <button
          type="button"
          class="submit-btn login-btn"
          onclick="window.location.href='{{ url_for('login') }}'"
        >
          <span>Anmelden</span>
          <i class="fa fa-sign-in"></i>
        </button>
      </form>
    </div>
    {% else %}
    <div class="form-section">
      <div class="form-grid">
        <button
          type="button"
          class="submit-btn"
          onclick="window.location.href='{{ url_for('settings') }}'"
        >
          <span>Zu den Einstellungen</span>
          <i class="fa fa-cog"></i>
        </button>

        <button
          type="button"
          class="submit-btn"
          onclick="window.location.href='{{ url_for('orders') }}'"
        >
          <span>Zu den Bestellungen</span>
          <i class="fa fa-receipt"></i>
        </button>

        <button
          type="button"
          class="submit-btn"
          onclick="window.location.href='{{ url_for('logout') }}'"
        >
          <span>Abmelden</span>
          <i class="fa fa-sign-out"></i>
        </button>
      </div>
    </div>
    {% endif %}
  </div>

  <div id="notification" class="notification success-notification">
    <i class="fa fa-check-circle"></i>
    <div class="notification-content">
      <h4>Erfolg!</h4>
      <p>Vielen Dank für deine Registrierung!</p>
    </div>
  </div>

  <div id="error-notification" class="notification error-notification">
    <i class="fa fa-exclamation-circle"></i>
    <div class="notification-content">
      <h4>Fehler</h4>
      <p id="error-text">Nicht alle Felder wurden ausgefüllt!</p>
    </div>
  </div>
</div>
<script>
  const inputs = document.querySelectorAll("input, textarea");
  inputs.forEach((input) => {
    input.addEventListener("focus", function () {
      this.parentElement.classList.add("focused");
    });

    input.addEventListener("blur", function () {
      if (!this.value) {
        this.parentElement.classList.remove("focused");
      }
    });
  });

  function validateName(name) {
    var regex = /^[a-zA-ZäöüÄÖÜéèêàâîïôûçß\s\-]+$/;
    return regex.test(name) && name.trim().length > 0;
  }

  function validateEmail(email) {
    var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  }

  function showError(message) {
    var errorNotification = document.getElementById("error-notification");
    var errorText = document.getElementById("error-text");
    errorText.textContent = message;
    errorNotification.classList.remove("hide");
    errorNotification.classList.add("show");

    if (errorTimeoutId !== null) {
      clearTimeout(errorTimeoutId);
    }

    errorTimeoutId = setTimeout(function () {
      errorNotification.classList.remove("show");
      errorNotification.classList.add("hide");
    }, 4000);
  }

  var errorTimeoutId = null;

  var registerButton = document.getElementById("registrieren-btn");
  if (registerButton) {
    registerButton.addEventListener("click", function (e) {
      e.preventDefault();

      var lastname = document.getElementById("lastname").value;
      var firstname = document.getElementById("firstname").value;
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;

      if (!lastname || !firstname || !email || !password) {
        showError("Nicht alle Felder wurden ausgefüllt!");
        return;
      }

      if (!validateName(lastname)) {
        showError("Nachname darf keine Zahlen enthalten");
        return;
      }

      if (!validateName(firstname)) {
        showError("Vorname darf keine Zahlen enthalten");
        return;
      }

      if (!validateEmail(email)) {
        showError("E-Mail muss ein @ enthalten und gültig sein");
        return;
      }

      var errorNotification = document.getElementById("error-notification");
      errorNotification.classList.remove("show");
      errorNotification.classList.add("hide");

      if (errorTimeoutId !== null) {
        clearTimeout(errorTimeoutId);
      }

      var formData = new FormData();
      formData.append("lastname", lastname);
      formData.append("firstname", firstname);
      formData.append("email", email);
      formData.append("password", password);

      fetch('{{ url_for("profil") }}', {
        method: "POST",
        body: formData,
      })
        .then(function (response) {
          if (response.ok) {
            document.getElementById("lastname").value = "";
            document.getElementById("firstname").value = "";
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";

            var notification = document.getElementById("notification");
            notification.classList.add("show");

            setTimeout(function () {
              notification.classList.remove("show");
              notification.classList.add("hide");
              window.location.reload();
            }, 4000);
          } else {
            showError(
              "Ein Fehler ist aufgetreten. Bitte versuche es später erneut.",
            );
          }
        })
        .catch(function () {
          showError("Netzwerkfehler. Bitte prüfe deine Verbindung.");
        });
    });
  }
</script>

{% endblock %}
