{% extends 'base.html' %}

{% block title %}Kasse | Flor'Avis{% endblock %}

{% block content %}
<head>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/checkout.css') }}"
    />
</head> 

    <form id="checkout-form" onsubmit="return false;">
        <div class="addres-card-container">

            <div class="addres-details">
                <div class="addres-details-title">Adressdetails</div>
                <div class="salutation">Anrede</div>

                <div class="salutation-buttons">
                    <label class="salutation-box">
                        <input type="radio" name="salutation" value="Herr" {% if checkout_data.get('salutation') == 'Herr' %}checked{% endif %}>
                        <span class="salutation-button"></span>
                        <span class="salutation-text">Herr</span>
                    </label>

                    <label class="salutation-box">
                        <input type="radio" name="salutation" value="Frau" {% if checkout_data.get('salutation') == 'Frau' %}checked{% endif %}>
                        <span class="salutation-button"></span>
                        <span class="salutation-text">Frau</span>
                    </label>

                    <label class="salutation-box">
                        <input type="radio" name="salutation" value="Keine" {% if checkout_data.get('salutation') == 'Keine' %}checked{% endif %}>
                        <span class="salutation-button"></span>
                        <span class="salutation-text">Keine Angabe</span>
                    </label>
                </div>

                <div class="name">Nachname</div>
                <label>
                    <input class="name-input" type="text" name="name" placeholder="Nachname" value="{{ checkout_data.get('name', '') }}">
                </label>
                <div class="surname">Vorname</div>
                <label>
                    <input class="surname-input" type="text" name="surname" placeholder="Vorname" value="{{ checkout_data.get('surname', '') }}">
                </label>
                <div class="addres">Straße + Nr.</div>
                <label>
                    <input class="addres-input" type="text" name="address" placeholder="Straße + Nr." value="{{ checkout_data.get('address', '') }}">
                </label>
                <div class="ortplz">
                    <div class="place-flex">
                        <div class="place">Postleitzahl</div>
                        <label>
                            <input
                                    class="place-input"
                                    type="text"
                                    name="plz"
                                    inputmode="numeric"
                                    maxlength="4"
                                    placeholder="8000"
                                    value="{{ checkout_data.get('plz', '') }}"
                            >
                        </label>
                    </div>
                    <div class="city-flex">
                        <div class="city">Stadt</div>
                        <label>
                            <input class="city-input" type="text" name="city" placeholder="Stadt" value="{{ checkout_data.get('city', '') }}">
                        </label>
                    </div>
                </div>
                <div class="tel">Telefonnummer</div>
                <label>
                    <input class="tel-input" type="tel" name="tel" placeholder="Telefonnummer" value="{{ checkout_data.get('tel', '') }}">
                </label>
                <div class="email">E-Mail</div>
                <label>
                    <input
                            class="email-input"
                            type="email"
                            name="email"
                            placeholder="name@beispiel.com"
                            autocomplete="email"
                            value="{{ checkout_data.get('email', '') }}"
                    >
                </label>
            </div>

            <div class="card-details">
                <div class="card-details-title">Kartendetails</div>

                <div class="payment-methods">Zahlungsmethoden</div>

                <div class="payment-methods-buttons">
                    <label class="payment-method">
                        <input type="radio" name="payment" value="mastercard" {% if checkout_data.get('payment') == 'mastercard' %}checked{% endif %} onchange="toggleCardDetails()">
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/mastercard_floravis.png" alt="Mastercard">
                        </span>
                    </label>

                    <label class="payment-method">
                        <input type="radio" name="payment" value="visa" {% if checkout_data.get('payment') == 'visa' %}checked{% endif %} onchange="toggleCardDetails()">
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/visa_floravis.png" alt="Visa">
                        </span>
                    </label>

                    <label class="payment-method">
                        <input type="radio" name="payment" value="twint" {% if checkout_data.get('payment') == 'twint' %}checked{% endif %} onchange="toggleCardDetails()">
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/twint_floravis.png" alt="Twint">
                        </span>
                    </label>

                    <label class="payment-method">
                        <input type="radio" name="payment" value="paypal" {% if checkout_data.get('payment') == 'paypal' %}checked{% endif %} onchange="toggleCardDetails()">
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/paypal_floravis.png" alt="Paypal">
                        </span>
                    </label>
                </div>


                <div class="card-details-fields" id="card-details-fields" style="display: none;">
                    <div class="card-name">Name auf Karte</div>
                <label>
                    <input class="name-input" type="text" name="card_name" placeholder="Name" value="{{ checkout_data.get('card_name', '') }}">
                </label>

                <div class="card-number">Kartennummer</div>
                <label>
                    <input
                            class="card-number-input"
                            type="text"
                            name="card_number"
                            inputmode="numeric"
                            maxlength="19"
                            placeholder="1234 5678 9012 3456"
                            value="{{ checkout_data.get('card_number', '') }}"
                    >
                </label>

                <div class="date-cvv">
                    <div class="date-flex">
                        <div class="date">Ablaufdatum</div>
                        <label>
                            <input
                                    class="date-input"
                                    type="text"
                                    name="expiration"
                                    inputmode="numeric"
                                    maxlength="5"
                                    placeholder="MM/YY"
                                    value="{{ checkout_data.get('expiration', '') }}"
                            >
                        </label>
                    </div>
                    <div class="cvv-flex">
                        <div class="cvv">CVV</div>
                        <label>
                            <input
                                    class="card-input"
                                    type="text"
                                    name="cvv"
                                    inputmode="numeric"
                                    autocomplete="cc-csc"
                                    placeholder="CVV"
                                    maxlength="4"
                                    value="{{ checkout_data.get('cvv', '') }}"
                            >
                        </label>
                    </div>
                </div>
                </div>

                <div class="txt">Zwischensumme</div>
                <div class="txt">Versand</div>
                <div class="txt">Gesamt (Steuern inbegriffen)</div>
                <button 
                    type="button" 
                    class="checkout-button" 
                    id="checkout-btn"
                    onclick="handleCheckout()"
                    aria-label="Bestellung abschließen und bezahlen"
                >
                    <span id="btn-text">Kasse</span>
                    <span id="btn-spinner" class="loading-spinner" style="display: none;" aria-hidden="true">
                        <i class="fa fa-spinner"></i>
                    </span>
                </button>
            </div>

        </div>
    </form>

    <!-- Toast Notification Container -->
    <div id="toast-container" role="region" aria-live="assertive" aria-atomic="true"></div>

    <!-- Thank You Screen -->
    <div class="thank-you-screen" id="thank-you-screen" role="status" aria-live="polite">
        <div class="thank-you-content">
            <div class="thank-you-icon">✓</div>
            <h1>Vielen Dank!</h1>
            <p>Ihre Bestellung wurde erfolgreich aufgegeben</p>
            <div class="thank-you-message">
                <p>Wir haben Ihre Bestellung erhalten und werden sie kürze verarbeiten.</p>
                <p>Eine Bestätigungse-Mail wird in den nächsten Minuten an Sie versendet.</p>
            </div>
            <a href="{{ url_for('shop') }}" class="back-to-shop">Zurück zum Shop</a>
            <a href="{{ url_for('orders') }}" class="view-orders">Meine Bestellungen anzeigen</a>
        </div>
    </div>

    <script>
        var lastSelectedPayment = null;

        // Toggle Card Details visibility with deselect on re-click
        function toggleCardDetails(clickedValue) {
            var paymentChecked = document.querySelector('input[name="payment"]:checked');
            var cardDetailsFields = document.getElementById('card-details-fields');
            
            // Wenn auf die gleiche Option geklickt wurde, abwählen
            if (lastSelectedPayment === clickedValue && paymentChecked && paymentChecked.value === clickedValue) {
                paymentChecked.checked = false;
                cardDetailsFields.style.display = 'none';
                lastSelectedPayment = null;
            } else {
                // Sonst normal anzeigen
                if (paymentChecked) {
                    cardDetailsFields.style.display = 'block';
                    cardDetailsFields.style.animation = 'fadeIn 0.3s ease-in';
                    lastSelectedPayment = paymentChecked.value;
                } else {
                    cardDetailsFields.style.display = 'none';
                    lastSelectedPayment = null;
                }
            }
        }

        // Speichere Formulardaten in der Session
        function saveFormData() {
            var form = document.getElementById('checkout-form');
            var formData = {
                salutation: form.querySelector('input[name="salutation"]:checked')?.value || '',
                name: form.querySelector('input[name="name"]').value,
                surname: form.querySelector('input[name="surname"]').value,
                address: form.querySelector('input[name="address"]').value,
                plz: form.querySelector('input[name="plz"]').value,
                city: form.querySelector('input[name="city"]').value,
                tel: form.querySelector('input[name="tel"]').value,
                email: form.querySelector('input[name="email"]').value,
                payment: form.querySelector('input[name="payment"]:checked')?.value || '',
                card_name: form.querySelector('input[name="card_name"]').value,
                card_number: form.querySelector('input[name="card_number"]').value,
                expiration: form.querySelector('input[name="expiration"]').value,
                cvv: form.querySelector('input[name="cvv"]').value
            };

            fetch('/save_checkout_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
        }

        // Event Listener für alle Input-Felder hinzufügen
        document.addEventListener('DOMContentLoaded', function() {
            var inputs = document.querySelectorAll('#checkout-form input');
            inputs.forEach(function(input) {
                input.addEventListener('change', saveFormData);
                input.addEventListener('input', saveFormData);
            });
            
            // Initialisiere die Sichtbarkeit der Kartendaten
            var paymentChecked = document.querySelector('input[name="payment"]:checked');
            if (paymentChecked) {
                lastSelectedPayment = paymentChecked.value;
                toggleCardDetails(paymentChecked.value);
            }
        });

        // Toast Notification anzeigen
        function showToast(message, type) {
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.innerHTML = '<span class="toast-icon">' + (type === 'error' ? '✕' : '✓') + '</span><span class="toast-message">' + message + '</span>';

            container.appendChild(toast);

            setTimeout(function() {
                toast.classList.add('show');
            }, 10);

            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }, 4000);
        }

        // Validierungsfunktionen
        function validateName(name) {
            // Keine Zahlen erlaubt
            var regex = /^[a-zA-ZäöüÄÖÜéèêàâîïôûçß\s\-]+$/;
            return regex.test(name) && name.trim().length > 0;
        }

        function validatePLZ(plz) {
            // Genau 4 Zahlen
            var regex = /^\d{4}$/;
            return regex.test(plz);
        }

        function validateEmail(email) {
            // Muss @ enthalten
            var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validatePhone(phone) {
            // Nur Zahlen, Leerzeichen, + und - erlaubt
            var regex = /^[\d\s\+\-]+$/;
            return regex.test(phone) && phone.trim().length >= 10;
        }

        function validateExpiration(expiration) {
            // Format MM/YY
            var regex = /^(0[1-9]|1[0-2])\/\d{2}$/;
            return regex.test(expiration);
        }

        function validateCardNumber(cardNumber) {
            // 13-19 Zahlen (mit oder ohne Leerzeichen)
            var cleaned = cardNumber.replace(/\s/g, '');
            var regex = /^\d{13,19}$/;
            return regex.test(cleaned);
        }

        function validateCVV(cvv) {
            // 3-4 Zahlen
            var regex = /^\d{3,4}$/;
            return regex.test(cvv);
        }

        // Speichere die Bestellung in userOrders
        function saveOrderToHistory() {
            // Hole aktuellen Warenkorb
            var cart = getCart();
            
            if (!cart || cart.length === 0) {
                return; // Kein Warenkorb zum Speichern
            }
            
            // Berechne Total
            var total = 0;
            cart.forEach(function(item) {
                total += item.price * item.quantity;
            });
            
            // Erstelle neue Order
            var newOrder = {
                id: Date.now(), // Eindeutige ID basierend auf Timestamp
                date: new Date().toISOString().split('T')[0], // Heutiges Datum
                items: cart,
                total: total,
                status: 'Pending'
            };
            
            // Lade bestehende Orders aus sessionStorage (wird beim Schließen gelöscht)
            var existingOrders = sessionStorage.getItem('userOrders');
            var orders = existingOrders ? JSON.parse(existingOrders) : [];
            
            // Füge neue Order hinzu
            orders.push(newOrder);
            
            // Speichere zurück in sessionStorage
            sessionStorage.setItem('userOrders', JSON.stringify(orders));
        }

        function handleCheckout() {
            var form = document.getElementById('checkout-form');
            var checkoutBtn = document.getElementById('checkout-btn');
            var btnText = document.getElementById('btn-text');
            var btnSpinner = document.getElementById('btn-spinner');

            if (!form) {
                showToast('Formular nicht gefunden!', 'error');
                return false;
            }

            // Prüfe Anrede (Radio)
            var salutationChecked = document.querySelector('input[name="salutation"]:checked');
            if (!salutationChecked) {
                showToast('Bitte wähle eine Anrede aus', 'error');
                return false;
            }

            // Prüfe Name (keine Zahlen)
            var nameInput = document.querySelector('input[name="name"]');
            if (!nameInput || !validateName(nameInput.value)) {
                showToast('Nachname darf keine Zahlen enthalten', 'error');
                if (nameInput) nameInput.focus();
                return false;
            }

            // Prüfe Vorname (keine Zahlen)
            var surnameInput = document.querySelector('input[name="surname"]');
            if (!surnameInput || !validateName(surnameInput.value)) {
                showToast('Vorname darf keine Zahlen enthalten', 'error');
                if (surnameInput) surnameInput.focus();
                return false;
            }

            // Prüfe Adresse
            var addressInput = document.querySelector('input[name="address"]');
            if (!addressInput || addressInput.value.trim() === '') {
                showToast('Bitte fülle das Feld "Straße + Nr." aus', 'error');
                if (addressInput) addressInput.focus();
                return false;
            }

            // Prüfe PLZ (genau 4 Zahlen)
            var plzInput = document.querySelector('input[name="plz"]');
            if (!plzInput || !validatePLZ(plzInput.value)) {
                showToast('Postleitzahl muss genau 4 Ziffern haben', 'error');
                if (plzInput) plzInput.focus();
                return false;
            }

            // Prüfe Ort
            var cityInput = document.querySelector('input[name="city"]');
            if (!cityInput || !validateName(cityInput.value)) {
                showToast('Stadt darf keine Zahlen enthalten', 'error');
                if (cityInput) cityInput.focus();
                return false;
            }

            // Prüfe Telefonnummer
            var telInput = document.querySelector('input[name="tel"]');
            if (!telInput || !validatePhone(telInput.value)) {
                showToast('Bitte gib eine gültige Telefonnummer ein (mind. 10 Ziffern)', 'error');
                if (telInput) telInput.focus();
                return false;
            }

            // Prüfe E-Mail (muss @ enthalten)
            var emailInput = document.querySelector('input[name="email"]');
            if (!emailInput || !validateEmail(emailInput.value)) {
                showToast('E-Mail muss ein @ enthalten und gültig sein', 'error');
                if (emailInput) emailInput.focus();
                return false;
            }

            // Prüfe Zahlungsmethode (Radio)
            var paymentChecked = document.querySelector('input[name="payment"]:checked');
            if (!paymentChecked) {
                showToast('Bitte wähle eine Zahlungsmethode aus', 'error');
                return false;
            }

            // Prüfe Name auf Karte (keine Zahlen)
            var cardNameInput = document.querySelector('input[name="card_name"]');
            if (!cardNameInput || !validateName(cardNameInput.value)) {
                showToast('Name auf Karte darf keine Zahlen enthalten', 'error');
                if (cardNameInput) cardNameInput.focus();
                return false;
            }

            // Prüfe Kartennummer
            var cardNumberInput = document.querySelector('input[name="card_number"]');
            if (!cardNumberInput || !validateCardNumber(cardNumberInput.value)) {
                showToast('Kartennummer muss 13-19 Ziffern haben', 'error');
                if (cardNumberInput) cardNumberInput.focus();
                return false;
            }

            // Prüfe Ablaufdatum (MM/YY)
            var expirationInput = document.querySelector('input[name="expiration"]');
            if (!expirationInput || !validateExpiration(expirationInput.value)) {
                showToast('Ablaufdatum muss im Format MM/YY sein (z.B. 03/25)', 'error');
                if (expirationInput) expirationInput.focus();
                return false;
            }

            // Prüfe CVV
            var cvvInput = document.querySelector('input[name="cvv"]');
            if (!cvvInput || !validateCVV(cvvInput.value)) {
                showToast('CVV muss 3-4 Ziffern haben', 'error');
                if (cvvInput) cvvInput.focus();
                return false;
            }

            // Zeige Loading-State
            checkoutBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline';
            checkoutBtn.setAttribute('aria-busy', 'true');

            // Alle Felder sind gültig - sende an Server
            var formData = new FormData(form);

            fetch('/checkout', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                if (response.ok) {
                    // WICHTIG: Bestellung speichern BEVOR der Warenkorb gelöscht wird
                    saveOrderToHistory();
                    
                    // Warenkorb leeren (localStorage löschen)
                    clearCart();

                    // Checkout Formular verstecken
                    document.querySelector('.addres-card-container').style.display = 'none';
                    
                    // Danke-Screen anzeigen
                    document.getElementById('thank-you-screen').style.display = 'flex';
                    
                    // Alle Textfelder leeren
                    var inputs = document.querySelectorAll('#checkout-form input[type="text"], #checkout-form input[type="email"], #checkout-form input[type="tel"]');
                    for (var j = 0; j < inputs.length; j++) {
                        inputs[j].value = '';
                    }

                    // Alle Radio-Buttons deselektieren
                    var radios = document.querySelectorAll('#checkout-form input[type="radio"]');
                    for (var k = 0; k < radios.length; k++) {
                        radios[k].checked = false;
                    }

                    // Nach 5 Sekunden zum Shop weiterleiten
                    setTimeout(function() {
                        window.location.href = '{{ url_for("shop") }}';
                    }, 5000);
                } else {
                    throw new Error('Checkout failed');
                }
            })
            .catch(function(error) {
                showToast('Ein Fehler ist aufgetreten: ' + error.message, 'error');
                // Reset Loading-State
                checkoutBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
                checkoutBtn.setAttribute('aria-busy', 'false');
            });

            return false;
        }
    </script>
{% endblock %}

