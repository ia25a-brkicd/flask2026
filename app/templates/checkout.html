{% extends 'base.html' %}

{% block title %}Kasse | Flor'Avis{% endblock %}

{% block content %}
<head>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/checkout.css') }}"
    />
</head>

<!-- QR-Code Bibliothek fuer Twint -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <a href="{{ url_for('warenkorb') }}" class="back-arrow" aria-label="Zurück zum Warenkorb">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>

    <form id="checkout-form" onsubmit="return false;">
        <div class="addres-card-container">

            <div class="addres-details">
                <div class="addres-details-title">Adressdetails</div>
                <div class="salutation">Anrede</div>

                <div class="salutation-buttons">
                    <label class="salutation-box">
                        <input type="radio" name="salutation" value="Herr" {% if checkout_data.get('salutation') == 'Herr' %}checked{% endif %}>
                        <span class="salutation-button"></span>
                        <span class="salutation-text">Herr</span>
                    </label>

                    <label class="salutation-box">
                        <input type="radio" name="salutation" value="Frau" {% if checkout_data.get('salutation') == 'Frau' %}checked{% endif %}>
                        <span class="salutation-button"></span>
                        <span class="salutation-text">Frau</span>
                    </label>

                    <label class="salutation-box">
                        <input type="radio" name="salutation" value="Keine" {% if checkout_data.get('salutation') == 'Keine' %}checked{% endif %}>
                        <span class="salutation-button"></span>
                        <span class="salutation-text">Keine Angabe</span>
                    </label>
                </div>

                <div class="name">Nachname</div>
                <label>
                    <input class="name-input" type="text" name="name" placeholder="Nachname" value="{{ checkout_data.get('name', '') }}">
                </label>
                <div class="surname">Vorname</div>
                <label>
                    <input class="surname-input" type="text" name="surname" placeholder="Vorname" value="{{ checkout_data.get('surname', '') }}">
                </label>
                <div class="addres">Straße + Nr.</div>
                <label>
                    <input class="addres-input" type="text" name="address" placeholder="Straße + Nr." value="{{ checkout_data.get('address', '') }}">
                </label>
                <div class="ortplz">
                    <div class="place-flex">
                        <div class="place">Postleitzahl</div>
                        <label>
                            <input
                                    class="place-input"
                                    type="text"
                                    name="plz"
                                    inputmode="numeric"
                                    maxlength="4"
                                    placeholder="8000"
                                    value="{{ checkout_data.get('plz', '') }}"
                            >
                        </label>
                    </div>
                    <div class="city-flex">
                        <div class="city">Stadt</div>
                        <label>
                            <input class="city-input" type="text" name="city" placeholder="Stadt" value="{{ checkout_data.get('city', '') }}">
                        </label>
                    </div>
                </div>
                <div class="tel">Telefonnummer</div>
                <label>
                    <input class="tel-input" type="tel" name="tel" placeholder="Telefonnummer" value="{{ checkout_data.get('tel', '') }}">
                </label>
                <div class="email">E-Mail</div>
                <label>
                    <input
                            class="email-input"
                            type="email"
                            name="email"
                            placeholder="name@beispiel.com"
                            autocomplete="email"
                            value="{{ checkout_data.get('email', '') }}"
                    >
                </label>
            </div>

            <div class="card-details">
                <div class="card-details-title">Kartendetails</div>

                <div class="payment-methods">Zahlungsmethoden</div>
                <p id="payment-lock-hint" style="font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:6px; margin-top:-4px; display:flex; align-items:center; gap:5px;">
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Zuerst Adressdetails ausfüllen
                </p>

                <div class="payment-methods-buttons" id="payment-methods-buttons">
                    <label class="payment-method">
                        <input type="radio" name="payment" value="mastercard" {% if checkout_data.get('payment') == 'mastercard' %}checked{% endif %} onchange="toggleCardDetails()" disabled>
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/mastercard_floravis.png" alt="Mastercard">
                        </span>
                    </label>

                    <label class="payment-method">
                        <input type="radio" name="payment" value="visa" {% if checkout_data.get('payment') == 'visa' %}checked{% endif %} onchange="toggleCardDetails()" disabled>
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/visa_floravis.png" alt="Visa">
                        </span>
                    </label>

                    <label class="payment-method">
                        <input type="radio" name="payment" value="twint" {% if checkout_data.get('payment') == 'twint' %}checked{% endif %} onchange="toggleCardDetails()" disabled>
                        <span class="payment-methods-button">
                            <img class="payment-methods-img" src="../static/styles/images/twint_floravis.png" alt="Twint">
                        </span>
                    </label>

                </div>


                <div class="card-details-fields" id="card-details-fields" style="display: none;">
                    <div class="card-name">Name auf Karte</div>
                <label>
                    <input class="name-input" type="text" name="card_name" placeholder="Name" value="{{ checkout_data.get('card_name', '') }}">
                </label>

                <div class="card-number">Kartennummer</div>
                <label>
                    <input
                            class="card-number-input"
                            type="text"
                            name="card_number"
                            inputmode="numeric"
                            maxlength="19"
                            placeholder="1234 5678 9012 3456"
                            value="{{ checkout_data.get('card_number', '') }}"
                    >
                </label>

                <div class="date-cvv">
                    <div class="date-flex">
                        <div class="date">Ablaufdatum</div>
                        <label>
                            <input
                                    class="date-input"
                                    type="text"
                                    name="expiration"
                                    inputmode="numeric"
                                    maxlength="5"
                                    placeholder="MM/YY"
                                    value="{{ checkout_data.get('expiration', '') }}"
                            >
                        </label>
                    </div>
                    <div class="cvv-flex">
                        <div class="cvv">CVV</div>
                        <label>
                            <input
                                    class="card-input"
                                    type="text"
                                    name="cvv"
                                    inputmode="numeric"
                                    autocomplete="cc-csc"
                                    placeholder="CVV"
                                    maxlength="4"
                                    value="{{ checkout_data.get('cvv', '') }}"
                            >
                        </label>
                    </div>
                </div>
                </div>

                <div class="order-summary">
                    <div class="summary-row">
                        <span class="summary-label">Zwischensumme</span>
                        <span class="summary-value" id="subtotal-value">CHF 0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Versand</span>
                        <span class="summary-value" id="shipping-value">CHF 0.00</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span class="summary-label">Gesamt</span>
                        <span class="summary-value" id="total-value">CHF 0.00</span>
                    </div>
                    <div class="summary-tax-note">(Steuern inbegriffen)</div>
                </div>

                <button 
                    type="button" 
                    class="checkout-button" 
                    id="checkout-btn"
                    onclick="handleCheckout()"
                    aria-label="Bestellung abschließen und bezahlen"
                >
                    <span id="btn-text">Zahlen</span>
                    <span id="btn-spinner" class="loading-spinner" style="display: none;" aria-hidden="true">
                        <i class="fa fa-spinner"></i>
                    </span>
                </button>
            </div>

        </div>
    </form>

    <!-- ============================================================ -->
    <!-- TWINT QR-CODE MODAL                                          -->
    <!-- ============================================================ -->
    <div id="twint-modal" class="twint-modal-overlay" style="display:none;" onclick="closeTwintModal(event)">
        <div class="twint-modal-box">
            <button class="twint-modal-close" onclick="closeTwintModal()">&#10005;</button>
            <img src="../static/styles/images/twint_floravis.png" alt="Twint" class="twint-logo">
            <h2>Mit TWINT bezahlen</h2>
            <p>Scanne den QR-Code</p>
            <!-- QR-Code wird hier generiert -->
            <div id="twint-qr-code"></div>
            <p class="twint-hint">QR-Code scannen &rarr; Betrag bestätigen</p>
            <a id="twint-test-link" href="#" target="_blank" style="display:block; margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.55); text-decoration: underline;">Ohne Handy hier klicken zum Testen</a>
            <div id="twint-waiting" style="margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:8px;">
                <div style="width:22px; height:22px; border:3px solid rgba(255,255,255,0.2); border-top-color:#fff; border-radius:50%; animation:twintSpin 0.8s linear infinite;"></div>
                <span style="font-size:12px; color:rgba(255,255,255,0.5);">Warte auf Zahlung…</span>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" role="region" aria-live="assertive" aria-atomic="true"></div>

    <!-- Thank You Screen -->
    <div class="thank-you-screen" id="thank-you-screen" role="status" aria-live="polite">
        <div class="thank-you-content">
            <div class="thank-you-icon">✓</div>
            <h1>Vielen Dank!</h1>
            <p>Ihre Bestellung wurde erfolgreich aufgegeben</p>
            <div class="thank-you-message">
                <p>Wir haben Ihre Bestellung erhalten und werden sie kürze verarbeiten.</p>
                <p>Eine Bestätigungse-Mail wird in den nächsten Minuten an Sie versendet.</p>
            </div>
            <a href="{{ url_for('shop') }}" class="back-to-shop">Zurück zum Shop</a>
            <a href="{{ url_for('orders') }}" class="view-orders">Meine Bestellungen anzeigen</a>
        </div>
    </div>

    <script>
        // ============================================================
        // TWINT KONFIGURATION
        // Hier die URL eintragen, auf die der QR-Code zeigen soll
        // (z.B. dein TWINT-Zahlungslink oder deine Webseite)
        // ============================================================
        var TWINT_BASE_URL = '{{ twint_pay_base_url }}';

        var lastSelectedPayment = null;
        var twintQrGenerated = false;

        // ============================================================
        // ADRESS-VALIDIERUNG → Zahlungsmethoden freischalten
        // ============================================================
        function checkAddressComplete() {
            var salutation = document.querySelector('input[name="salutation"]:checked');
            var name     = document.querySelector('input[name="name"]').value.trim();
            var surname  = document.querySelector('input[name="surname"]').value.trim();
            var address  = document.querySelector('input[name="address"]').value.trim();
            var plz      = document.querySelector('input[name="plz"]').value.trim();
            var city     = document.querySelector('input[name="city"]').value.trim();
            var tel      = document.querySelector('input[name="tel"]').value.trim();
            var email    = document.querySelector('input[name="email"]').value.trim();

            var complete = salutation && name && surname && address && plz && city && tel && email;

            document.querySelectorAll('input[name="payment"]').forEach(function(r) {
                r.disabled = !complete;
            });

            var btns = document.getElementById('payment-methods-buttons');
            var hint = document.getElementById('payment-lock-hint');
            if (complete) {
                btns.style.opacity = '1';
                btns.style.pointerEvents = 'auto';
                hint.style.display = 'none';
            } else {
                btns.style.opacity = '0.4';
                btns.style.pointerEvents = 'none';
                hint.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Auf alle Adressfelder hören
            ['input[name="name"]','input[name="surname"]','input[name="address"]',
             'input[name="plz"]','input[name="city"]','input[name="tel"]','input[name="email"]'
            ].forEach(function(sel) {
                var el = document.querySelector(sel);
                if (el) el.addEventListener('input', checkAddressComplete);
            });
            document.querySelectorAll('input[name="salutation"]').forEach(function(r) {
                r.addEventListener('change', checkAddressComplete);
            });
            // Beim Laden sofort prüfen (falls Felder bereits ausgefüllt sind)
            checkAddressComplete();
        });

        // Warenkorb-Funktionen
        function getCart() {
            var cart = localStorage.getItem('cart');
            return cart ? JSON.parse(cart) : [];
        }

        function clearCart() {
            localStorage.removeItem('cart');
        }

        function calculateTotals() {
            var cart = getCart();
            var subtotal = 0;
            
            cart.forEach(function(item) {
                var total = item.price * item.quantity;

                if (item.quantity === 2) {
                total = total * 0.9; // 10% discount
                } else if (item.quantity >= 3) {
                total = total * 0.8; // 20% discount
                }
                
                total = Math.floor(total) + 0.99;

                subtotal += total;
            });
            
            var shipping = subtotal > 0 ? 5.00 : 0; // CHF 5 Versandkosten, falls Warenkorb nicht leer
            var total = subtotal + shipping;
            
            return {
                subtotal: subtotal,
                shipping: shipping,
                total: total
            };
        }

        function updateOrderSummary() {
            var totals = calculateTotals();
            
            document.getElementById('subtotal-value').textContent = 'CHF ' + totals.subtotal.toFixed(2);
            document.getElementById('shipping-value').textContent = 'CHF ' + totals.shipping.toFixed(2);
            document.getElementById('total-value').textContent = 'CHF ' + totals.total.toFixed(2);
        }

        // Toggle Card Details visibility with deselect on re-click
        function toggleCardDetails(clickedValue) {
            var paymentChecked = document.querySelector('input[name="payment"]:checked');
            var cardDetailsFields = document.getElementById('card-details-fields');

            // --- TWINT: QR-Code Modal anzeigen ---
            if (paymentChecked && paymentChecked.value === 'twint') {
                cardDetailsFields.style.display = 'none';
                lastSelectedPayment = 'twint';
                showTwintQR();
                return;
            }

            // Wenn auf die gleiche Option geklickt wurde, abwählen
            if (lastSelectedPayment === clickedValue && paymentChecked && paymentChecked.value === clickedValue) {
                paymentChecked.checked = false;
                cardDetailsFields.style.display = 'none';
                lastSelectedPayment = null;
            } else {
                // Sonst normal anzeigen
                if (paymentChecked) {
                    cardDetailsFields.style.display = 'block';
                    cardDetailsFields.style.animation = 'fadeIn 0.3s ease-in';
                    lastSelectedPayment = paymentChecked.value;
                } else {
                    cardDetailsFields.style.display = 'none';
                    lastSelectedPayment = null;
                }
            }
        }

        // --- Twint QR-Code anzeigen ---
        var twintPollInterval = null;

        function generateToken() {
            return 'tw-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
        }

        function startTwintPolling(token) {
            if (twintPollInterval) clearInterval(twintPollInterval);
            twintPollInterval = setInterval(function() {
                fetch('/twint-status/' + token)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.paid) {
                            clearInterval(twintPollInterval);
                            var waiting = document.getElementById('twint-waiting');
                            if (waiting) waiting.innerHTML = '<span style="font-size:14px; color:#7ddf9b; font-weight:600;">✓ Zahlung erhalten!</span>';
                            setTimeout(function() { confirmTwintPayment(); }, 800);
                        }
                    })
                    .catch(function() {});
            }, 1000);
        }

        function showTwintQR() {
            var modal = document.getElementById('twint-modal');
            var qrContainer = document.getElementById('twint-qr-code');

            // Aktuellen Betrag berechnen und URL generieren
            var totals = calculateTotals();
            var token = generateToken();
            var twintUrl = TWINT_BASE_URL + '?total=' + totals.total.toFixed(2) + '&token=' + token;

            // Test-Link aktualisieren
            document.getElementById('twint-test-link').href = twintUrl;

            // Server-Polling starten
            startTwintPolling(token);

            // QR-Code immer neu generieren (damit Betrag stimmt)
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: twintUrl,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            modal.style.display = 'flex';
        }

        // --- Twint Modal schliessen ---
        function closeTwintModal(event) {
            // Nur schliessen wenn auf den Overlay (nicht die Box) geklickt wird
            if (event && event.target !== document.getElementById('twint-modal')) return;
            document.getElementById('twint-modal').style.display = 'none';
            // Auswahl zuruecksetzen
            var twintRadio = document.querySelector('input[name="payment"][value="twint"]');
            if (twintRadio) twintRadio.checked = false;
            lastSelectedPayment = null;
        }

        // --- Twint Zahlung bestaetigt (Modal schliessen, Checkout fortfahren) ---
        function confirmTwintPayment() {
            document.getElementById('twint-modal').style.display = 'none';
            showToast('TWINT-Zahlung bestätigt! Bestellung wird verarbeitet...', 'success');
            // Direkt Checkout abschliessen
            setTimeout(function() { handleCheckout(true); }, 800);
        }

        // Speichere Formulardaten in der Session
        function saveFormData() {
            var form = document.getElementById('checkout-form');
            var formData = {
                salutation: form.querySelector('input[name="salutation"]:checked')?.value || '',
                name: form.querySelector('input[name="name"]').value,
                surname: form.querySelector('input[name="surname"]').value,
                address: form.querySelector('input[name="address"]').value,
                plz: form.querySelector('input[name="plz"]').value,
                city: form.querySelector('input[name="city"]').value,
                tel: form.querySelector('input[name="tel"]').value,
                email: form.querySelector('input[name="email"]').value,
                payment: form.querySelector('input[name="payment"]:checked')?.value || '',
                card_name: form.querySelector('input[name="card_name"]').value,
                card_number: form.querySelector('input[name="card_number"]').value,
                expiration: form.querySelector('input[name="expiration"]').value,
                cvv: form.querySelector('input[name="cvv"]').value
            };

            fetch('/save_checkout_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
        }

        // Automatische Formatierung des Ablaufdatums (MM/YY)
        function formatExpiration(input) {
            var value = input.value.replace(/\D/g, ''); // Entferne alle Nicht-Zahlen
            
            if (value.length >= 3) {
                // Wenn 3 oder mehr Zahlen, füge "/" nach den ersten 2 Zahlen hinzu
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            
            input.value = value;
        }

        // Event Listener für alle Input-Felder hinzufügen
        document.addEventListener('DOMContentLoaded', function() {
            // Beträge beim Laden aktualisieren
            updateOrderSummary();
            
            var inputs = document.querySelectorAll('#checkout-form input');
            inputs.forEach(function(input) {
                input.addEventListener('change', saveFormData);
                input.addEventListener('input', saveFormData);
            });
            
            // Automatische Formatierung für Ablaufdatum
            var expirationInput = document.querySelector('input[name="expiration"]');
            if (expirationInput) {
                expirationInput.addEventListener('input', function() {
                    formatExpiration(this);
                });
            }
            
            // Initialisiere die Sichtbarkeit der Kartendaten
            var paymentChecked = document.querySelector('input[name="payment"]:checked');
            if (paymentChecked) {
                lastSelectedPayment = paymentChecked.value;
                toggleCardDetails(paymentChecked.value);
            }
        });

        // Toast Notification anzeigen
        function showToast(message, type) {
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.innerHTML = '<span class="toast-icon">' + (type === 'error' ? '✕' : '✓') + '</span><span class="toast-message">' + message + '</span>';

            container.appendChild(toast);

            setTimeout(function() {
                toast.classList.add('show');
            }, 10);

            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }, 4000);
        }

        // Validierungsfunktionen
        function validateName(name) {
            // Keine Zahlen erlaubt
            var regex = /^[a-zA-ZäöüÄÖÜéèêàâîïôûçß\s\-]+$/;
            return regex.test(name) && name.trim().length > 0;
        }

        function validatePLZ(plz) {
            // Genau 4 Zahlen
            var regex = /^\d{4}$/;
            return regex.test(plz);
        }

        function validateEmail(email) {
            // Muss @ enthalten
            var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validatePhone(phone) {
            // Nur Zahlen, Leerzeichen, + und - erlaubt
            var regex = /^[\d\s\+\-]+$/;
            return regex.test(phone) && phone.trim().length >= 10;
        }

        function validateExpiration(expiration) {
            // Format MM/YY
            var regex = /^(0[1-9]|1[0-2])\/\d{2}$/;
            return regex.test(expiration);
        }

        function validateCardNumber(cardNumber) {
            // 13-19 Zahlen (mit oder ohne Leerzeichen)
            var cleaned = cardNumber.replace(/\s/g, '');
            var regex = /^\d{13,19}$/;
            return regex.test(cleaned);
        }

        function validateCVV(cvv) {
            // 3-4 Zahlen
            var regex = /^\d{3,4}$/;
            return regex.test(cvv);
        }

        // Speichere die Bestellung in userOrders
        function saveOrderToHistory() {
            // Hole aktuellen Warenkorb
            var cart = getCart();
            
            if (!cart || cart.length === 0) {
                return; // Kein Warenkorb zum Speichern
            }
            
            // Berechne Total
            var total = 0;
            cart.forEach(function(item) {
                total += item.price * item.quantity;
            });
            
            // Erstelle neue Order
            var newOrder = {
                id: Date.now(), // Eindeutige ID basierend auf Timestamp
                date: new Date().toISOString().split('T')[0], // Heutiges Datum
                items: cart,
                total: total,
                status: 'Pending'
            };
            
            // Lade bestehende Orders aus sessionStorage (wird beim Schließen gelöscht)
            var existingOrders = sessionStorage.getItem('userOrders');
            var orders = existingOrders ? JSON.parse(existingOrders) : [];
            
            // Füge neue Order hinzu
            orders.push(newOrder);
            
            // Speichere zurück in sessionStorage
            sessionStorage.setItem('userOrders', JSON.stringify(orders));
        }

        function handleCheckout(twintConfirmed) {
            var form = document.getElementById('checkout-form');
            var checkoutBtn = document.getElementById('checkout-btn');
            var btnText = document.getElementById('btn-text');
            var btnSpinner = document.getElementById('btn-spinner');

            if (!form) {
                showToast('Formular nicht gefunden!', 'error');
                return false;
            }

            // Prüfe Anrede (Radio)
            var salutationChecked = document.querySelector('input[name="salutation"]:checked');
            if (!salutationChecked) {
                showToast('Bitte wähle eine Anrede aus', 'error');
                return false;
            }

            // Prüfe Name (keine Zahlen)
            var nameInput = document.querySelector('input[name="name"]');
            if (!nameInput || !validateName(nameInput.value)) {
                showToast('Nachname darf keine Zahlen enthalten', 'error');
                if (nameInput) nameInput.focus();
                return false;
            }

            // Prüfe Vorname (keine Zahlen)
            var surnameInput = document.querySelector('input[name="surname"]');
            if (!surnameInput || !validateName(surnameInput.value)) {
                showToast('Vorname darf keine Zahlen enthalten', 'error');
                if (surnameInput) surnameInput.focus();
                return false;
            }

            // Prüfe Adresse
            var addressInput = document.querySelector('input[name="address"]');
            if (!addressInput || addressInput.value.trim() === '') {
                showToast('Bitte fülle das Feld "Straße + Nr." aus', 'error');
                if (addressInput) addressInput.focus();
                return false;
            }

            // Prüfe PLZ (genau 4 Zahlen)
            var plzInput = document.querySelector('input[name="plz"]');
            if (!plzInput || !validatePLZ(plzInput.value)) {
                showToast('Postleitzahl muss genau 4 Ziffern haben', 'error');
                if (plzInput) plzInput.focus();
                return false;
            }

            // Prüfe Ort
            var cityInput = document.querySelector('input[name="city"]');
            if (!cityInput || !validateName(cityInput.value)) {
                showToast('Stadt darf keine Zahlen enthalten', 'error');
                if (cityInput) cityInput.focus();
                return false;
            }

            // Prüfe Telefonnummer
            var telInput = document.querySelector('input[name="tel"]');
            if (!telInput || !validatePhone(telInput.value)) {
                showToast('Bitte gib eine gültige Telefonnummer ein (mind. 10 Ziffern)', 'error');
                if (telInput) telInput.focus();
                return false;
            }

            // Prüfe E-Mail (muss @ enthalten)
            var emailInput = document.querySelector('input[name="email"]');
            if (!emailInput || !validateEmail(emailInput.value)) {
                showToast('E-Mail muss ein @ enthalten und gültig sein', 'error');
                if (emailInput) emailInput.focus();
                return false;
            }

            // Prüfe Zahlungsmethode (Radio)
            var paymentChecked = document.querySelector('input[name="payment"]:checked');
            if (!paymentChecked) {
                showToast('Bitte wähle eine Zahlungsmethode aus', 'error');
                return false;
            }

            // Kartenfelder nur validieren wenn NICHT Twint
            if (paymentChecked.value !== 'twint') {
                // Prüfe Name auf Karte (keine Zahlen)
                var cardNameInput = document.querySelector('input[name="card_name"]');
                if (!cardNameInput || !validateName(cardNameInput.value)) {
                    showToast('Name auf Karte darf keine Zahlen enthalten', 'error');
                    if (cardNameInput) cardNameInput.focus();
                    return false;
                }

                // Prüfe Kartennummer
                var cardNumberInput = document.querySelector('input[name="card_number"]');
                if (!cardNumberInput || !validateCardNumber(cardNumberInput.value)) {
                    showToast('Kartennummer muss 13-19 Ziffern haben', 'error');
                    if (cardNumberInput) cardNumberInput.focus();
                    return false;
                }

                // Prüfe Ablaufdatum (MM/YY)
                var expirationInput = document.querySelector('input[name="expiration"]');
                if (!expirationInput || !validateExpiration(expirationInput.value)) {
                    showToast('Ablaufdatum muss im Format MM/YY sein (z.B. 03/25)', 'error');
                    if (expirationInput) expirationInput.focus();
                    return false;
                }

                // Prüfe CVV
                var cvvInput = document.querySelector('input[name="cvv"]');
                if (!cvvInput || !validateCVV(cvvInput.value)) {
                    showToast('CVV muss 3-4 Ziffern haben', 'error');
                    if (cvvInput) cvvInput.focus();
                    return false;
                }
            }

            // Bei normalem Klick auf "Zahlen" und Twint ausgewaehlt: Modal oeffnen statt direkt bezahlen
            if (paymentChecked.value === 'twint' && !twintConfirmed) {
                showTwintQR();
                return false;
            }

            // Zeige Loading-State
            checkoutBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline';
            checkoutBtn.setAttribute('aria-busy', 'true');

            // Alle Felder sind gültig - sende an Server
            var formData = new FormData(form);

            // WICHTIG: Warenkorb-Daten zum FormData hinzufügen
            var cart = getCart();
            formData.append('cart_data', JSON.stringify(cart));

            fetch('/checkout', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                if (response.ok) {
                    // WICHTIG: Bestellung speichern BEVOR der Warenkorb gelöscht wird
                    saveOrderToHistory();
                    
                    // Warenkorb leeren (localStorage löschen)
                    clearCart();

                    // Checkout Formular verstecken
                    document.querySelector('.addres-card-container').style.display = 'none';
                    
                    // Danke-Screen anzeigen
                    document.getElementById('thank-you-screen').style.display = 'flex';
                    
                    // Alle Textfelder leeren
                    var inputs = document.querySelectorAll('#checkout-form input[type="text"], #checkout-form input[type="email"], #checkout-form input[type="tel"]');
                    for (var j = 0; j < inputs.length; j++) {
                        inputs[j].value = '';
                    }

                    // Alle Radio-Buttons deselektieren
                    var radios = document.querySelectorAll('#checkout-form input[type="radio"]');
                    for (var k = 0; k < radios.length; k++) {
                        radios[k].checked = false;
                    }

                    // Auto-Redirect entfernt: Danke-Screen bleibt bis Button-Klick
                } else {
                    throw new Error('Checkout failed');
                }
            })
            .catch(function(error) {
                showToast('Ein Fehler ist aufgetreten: ' + error.message, 'error');
                // Reset Loading-State
                checkoutBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
                checkoutBtn.setAttribute('aria-busy', 'false');
            });

            return false;
        }
    </script>
{% endblock %}

